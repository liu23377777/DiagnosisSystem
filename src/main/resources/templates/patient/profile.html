<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸ªäººä¿¡æ¯ - ä¸­åŒ»æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    body { background: #f6f7fb; }
    .container { max-width: 900px; }
    .card { border: 0; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .header { display:flex; align-items:center; justify-content:space-between; margin: 20px 0; }
    .header h2 { margin:0; }
    .avatar { width: 72px; height: 72px; border-radius: 50%; object-fit: cover; border: 2px solid #e9ecef; background:#fff; }
    .muted { color:#6c757d; }
      .avatar-preview{
    width: 96px;          /* éœ€è¦æ›´å°å°±è°ƒæˆ 72 */
    height: 96px;
    border-radius: 50%;   /* è¦æ–¹å½¢å¯å»æ‰ */
    object-fit: cover;    /* è£å‰ªå……æ»¡ */
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
    background:#fff;
  }
  </style>
</head>
<body>
<div class="container py-3">
  <div class="header">
    <div>
      <h2>ä¸ªäººä¿¡æ¯</h2>
      <div class="muted">æŸ¥çœ‹ä¸ä¿®æ”¹ä¸ªäººèµ„æ–™ï¼ˆæ‚£è€…ï¼‰</div>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="/patient/home">è¿”å›é¦–é¡µ</a>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body d-flex align-items-center gap-3">
      <div style="position: relative;">
        <img id="avatar" class="avatar-preview" src="/images/avatar-placeholder.svg" alt="å¤´åƒ" />
        <label for="avatarInput" style="position: absolute; bottom: 0; right: 0; background: #667eea; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px;" title="ç‚¹å‡»ä¸Šä¼ å¤´åƒ">
          ğŸ“·
        </label>
        <input type="file" id="avatarInput" accept="image/*" style="display: none;" />
      </div>
      <div>
        <div class="fw-bold" id="displayName">åŠ è½½ä¸­...</div>
        <div class="muted" id="displayUsername"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <form id="profileForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">çœŸå®å§“å</label>
            <input class="form-control" id="realName" placeholder="è¯·è¾“å…¥çœŸå®å§“å" />
          </div>
          <div class="col-md-6">
            <label class="form-label">æ‰‹æœºå·</label>
            <input class="form-control" id="phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
          </div>
          <div class="col-md-6">
            <label class="form-label">é‚®ç®±</label>
            <input class="form-control" id="email" placeholder="è¯·è¾“å…¥é‚®ç®±" />
          </div>
          <div class="col-md-6">
            <label class="form-label">æ€§åˆ«</label>
            <select class="form-select" id="gender">
              <option value="">æœªè®¾ç½®</option>
              <option value="0">ç”·</option>
              <option value="1">å¥³</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
            <input type="date" class="form-control" id="birthDate" />
          </div>
          <div class="col-md-6">
            <label class="form-label">åœ°å€</label>
            <input class="form-control" id="address" placeholder="è¯·è¾“å…¥åœ°å€" />
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
          <button type="button" class="btn btn-outline-primary" onclick="loadProfile()">é‡æ–°åŠ è½½</button>
          <button type="button" class="btn btn-outline-danger ms-auto" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
      </form>

      <div id="msg" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
  function getToken() {
    const t = localStorage.getItem('token');
    return t ? ('Bearer ' + t) : null;
  }

  function showMsg(type, text) {
    const el = document.getElementById('msg');
    el.innerHTML = `<div class="alert alert-${type}" role="alert">${text}</div>`;
  }

  function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('userId');
    localStorage.removeItem('username');
    localStorage.removeItem('role');
    location.href = '/login';
  }

  function normalizeDateToInput(value) {
    if (!value) return '';
    // å…¼å®¹ "2025-12-22" æˆ– "2025-12-22 21:23:26" æˆ– ISO
    const s = String(value);
    return s.substring(0, 10);
  }

  async function loadProfile() {
    const auth = getToken();
    if (!auth) {
      showMsg('warning', 'æœªæ£€æµ‹åˆ°ç™»å½•ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
      setTimeout(() => location.href = '/login', 800);
      return;
    }

    try {
      const res = await fetch('/api/patient/info', {
        headers: { 'Authorization': auth }
      });
      const data = await res.json();
      if (data.code !== 200) {
        showMsg('danger', data.message || 'åŠ è½½å¤±è´¥');
        return;
      }

      const p = data.data;
      document.getElementById('displayName').textContent = p.realName || p.username || 'æ‚£è€…';
      document.getElementById('displayUsername').textContent = p.username ? ('ç”¨æˆ·åï¼š' + p.username) : '';
      document.getElementById('avatar').src = p.avatarUrl || '/images/avatar-placeholder.svg';

      document.getElementById('realName').value = p.realName || '';
      document.getElementById('phone').value = p.phone || '';
      document.getElementById('email').value = p.email || '';
      document.getElementById('gender').value = (p.gender === 0 || p.gender === 1) ? String(p.gender) : '';
      document.getElementById('birthDate').value = normalizeDateToInput(p.birthDate);
      document.getElementById('address').value = p.address || '';

      document.getElementById('msg').innerHTML = '';
    } catch (e) {
      showMsg('danger', 'åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥ï¼š' + e.message);
    }
  }

  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const auth = getToken();
    if (!auth) {
      showMsg('warning', 'æœªæ£€æµ‹åˆ°ç™»å½•ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
      return;
    }

    const payload = {
      realName: document.getElementById('realName').value || null,
      phone: document.getElementById('phone').value || null,
      email: document.getElementById('email').value || null,
      gender: document.getElementById('gender').value === '' ? null : Number(document.getElementById('gender').value),
      birthDate: document.getElementById('birthDate').value || null,
      address: document.getElementById('address').value || null,
    };

    try {
      const res = await fetch('/api/patient/info', {
        method: 'PUT',
        headers: {
          'Authorization': auth,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.code !== 200) {
        showMsg('danger', data.message || 'ä¿å­˜å¤±è´¥');
        return;
      }
      showMsg('success', data.message || 'ä¿å­˜æˆåŠŸ');
      await loadProfile();
    } catch (e) {
      showMsg('danger', 'ä¿å­˜å¤±è´¥ï¼š' + e.message);
    }
  });

  // å¤´åƒä¸Šä¼ 
  document.getElementById('avatarInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    // éªŒè¯æ–‡ä»¶å¤§å°
    if (file.size > 5 * 1024 * 1024) {
      showMsg('danger', 'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
      return;
    }

    // éªŒè¯æ–‡ä»¶ç±»å‹
    if (!file.type.startsWith('image/')) {
      showMsg('danger', 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
      return;
    }

    const auth = getToken();
    if (!auth) {
      showMsg('warning', 'æœªæ£€æµ‹åˆ°ç™»å½•ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
      return;
    }

    try {
      showMsg('info', 'ä¸Šä¼ ä¸­...');
      const formData = new FormData();
      formData.append('file', file);

      const res = await fetch('/api/patient/avatar', {
        method: 'POST',
        headers: {
          'Authorization': auth
        },
        body: formData
      });

      const data = await res.json();
      if (data.code !== 200) {
        showMsg('danger', data.message || 'ä¸Šä¼ å¤±è´¥');
        return;
      }

      showMsg('success', 'å¤´åƒä¸Šä¼ æˆåŠŸ');
      // æ›´æ–°å¤´åƒæ˜¾ç¤º
      document.getElementById('avatar').src = data.data + '?t=' + Date.now();
      // é‡æ–°åŠ è½½ä¸ªäººä¿¡æ¯
      await loadProfile();
    } catch (e) {
      showMsg('danger', 'ä¸Šä¼ å¤±è´¥ï¼š' + e.message);
    }
  });

  // åˆå§‹åŒ–
  loadProfile();
</script>
</body>
</html>

