<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人设置 - 管理员</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 2rem;
            color: #333;
        }
        .container { max-width: 800px; }
            .card { 
            border: 0; 
            border-radius: 12px; 
            box-shadow: 0 6px 18px rgba(0,0,0,.08);
        }

        /* 新增头像样式 */
        .avatar-preview{
            width: 96px;          /* 根据需要改成 72 / 120 等 */
            height: 96px;
            object-fit: cover;    /* 裁剪充满 */
            border-radius: 50%;   /* 如果想要圆形头像，留方形就删这一行 */
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,.15);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white mb-0">⚙️ 个人设置</h2>
        <a href="/admin/dashboard" class="btn btn-light">返回控制台</a>
    </div>

    <div class="card">
        <div class="card-body p-4">
            <div class="d-flex align-items-center gap-4 mb-4">
                <img id="avatarPreview" class="avatar-preview" src="/images/avatar-placeholder.svg" alt="头像">
                    <input type="file" id="avatarInput" accept="image/*" style="display:none">
                    <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('avatarInput').click()">更换头像</button>
                <div>
                    <h4 id="realNameDisplay" class="mb-0">加载中...</h4>
                    <div id="usernameDisplay" class="text-muted"></div>
                </div>
            </div>

            <form id="profileForm">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">真实姓名</label>
                        <input id="realName" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">用户名</label>
                        <input id="username" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">手机号</label>
                        <input id="phone" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">邮箱</label>
                        <input id="email" type="email" class="form-control">
                    </div>
                </div>

                <div class="d-flex gap-2 mt-4">
                    <button type="submit" class="btn btn-primary">保存修改</button>
                    <button type="button" class="btn btn-outline-danger ms-auto" onclick="logout()">退出登录</button>
                </div>
                <div id="msg" class="mt-3"></div>
            </form>
        </div>
    </div>
</div>

<script>
    function getToken() {
        const ls = localStorage.getItem('token');
        if (ls) return ls;
        const m = document.cookie.match(/(?:^|;\s*)token=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : null;
    }
    const token = getToken();

    window.onload = function() {
        if (!token) {
            alert('请先登录');
            location.href = '/login';
            return;
        }
        loadProfile();
    };

    async function loadProfile() {
        try {
            const res = await fetch('/api/admin/info', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const result = await res.json();
            if (result.code !== 200) {
                showMsg('danger', result.message || '加载失败');
                return;
            }
            const admin = result.data;
            document.getElementById('realNameDisplay').textContent = admin.realName || '未设置姓名';
            document.getElementById('usernameDisplay').textContent = '@' + (admin.username || '');

            document.getElementById('realName').value = admin.realName || '';
            document.getElementById('username').value = admin.username || '';
            document.getElementById('phone').value = admin.phone || '';
            document.getElementById('email').value = admin.email || '';
        } catch (e) {
            showMsg('danger', '网络错误: ' + e.message);
        }
    }

    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            phone: document.getElementById('phone').value.trim(),
            email: document.getElementById('email').value.trim()
        };
        
        // 基本验证
        if (formData.phone && !/^1[3-9]\d{9}$/.test(formData.phone)) {
            showMsg('danger', '手机号格式不正确');
            return;
        }
        if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
            showMsg('danger', '邮箱格式不正确');
            return;
        }
        
        try {
            showMsg('info', '保存中...');
            const res = await fetch('/api/admin/info', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(formData)
            });
            
            const result = await res.json();
            if (result.code === 200) {
                showMsg('success', '保存成功！');
                setTimeout(() => {
                    loadProfile(); // 重新加载数据
                }, 1000);
            } else {
                showMsg('danger', result.message || '保存失败');
            }
        } catch (e) {
            showMsg('danger', '网络错误: ' + e.message);
        }
    });

    function logout() {
        if (confirm('确定退出登录吗?')) {
            localStorage.clear();
            document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            location.href = '/login';
        }
    }

    function showMsg(type, text) {
        const el = document.getElementById('msg');
        el.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
    }



    document.getElementById('avatarInput').addEventListener('change', async e=>{
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 5*1024*1024) { alert('图片不能超过5MB'); return; }
    if (!file.type.startsWith('image/')) { alert('请选择图片'); return; }

    const fd = new FormData(); fd.append('file', file);
    const res = await fetch('/api/admin/avatar', {
        method:'POST',
        headers:{'Authorization':'Bearer '+token},
        body:fd
    });
    const data = await res.json();
    if (data.code===200){
        document.getElementById('avatarPreview').src = data.data + '?t=' + Date.now();
    }else{
        alert(data.message||'上传失败');
    }
    });
</script>
</body>
</html>
