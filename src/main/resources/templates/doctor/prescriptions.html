<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤„æ–¹ç®¡ç† - åŒ»ç”Ÿç«¯</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f6f7fa;padding-top:2rem}
    .card{border:0;box-shadow:0 2px 8px rgba(0,0,0,.06);border-radius:12px}
    .item-row td{vertical-align:middle}
    .pill{font-size:.85rem;color:#6c757d}
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ğŸ’Š å¤„æ–¹ç®¡ç†</h2>
    <div>
      <button class="btn btn-outline-secondary" onclick="history.back()">è¿”å›</button>
      <button class="btn btn-primary" onclick="loadMy()">åˆ·æ–°</button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-5">
      <div class="card">
        <div class="card-body">
          <h5 class="mb-3">å¼€å…·æ–°å¤„æ–¹</h5>

          <div class="mb-3">
            <label class="form-label">æ‚£è€…ID</label>
            <input id="patientId" class="form-control" placeholder="ä¾‹å¦‚ 1">
          </div>

          <div class="mb-3">
            <label class="form-label">è¯å“æœç´¢ï¼ˆåç§°/æ‹¼éŸ³ç /ç¼–ç ï¼‰</label>
            <div class="input-group">
              <input id="drugKeyword" class="form-control" placeholder="ä¾‹å¦‚ é¢—ç²’ / ZXKL">
              <button class="btn btn-outline-primary" onclick="searchDrug()">æœç´¢</button>
            </div>
            <div class="form-text">æ•°æ®æ¥æºï¼šdrug_catalog_sql_results</div>
          </div>

          <div class="mb-3">
            <label class="form-label">æœç´¢ç»“æœ</label>
            <select id="drugSelect" class="form-select" size="6"></select>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-sm btn-outline-primary" onclick="addSelectedDrug()">åŠ å…¥æ˜ç»†</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="clearItems()">æ¸…ç©ºæ˜ç»†</button>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">ç”¨æ³•ç”¨é‡ï¼ˆå¯é€‰ï¼‰</label>
            <input id="dosage" class="form-control" placeholder="ä¾‹å¦‚ï¼šä¸€æ—¥ä¸‰æ¬¡ï¼Œæ¯æ¬¡1è¢‹">
          </div>

          <div class="d-grid">
            <button class="btn btn-success" onclick="submitPrescription()">æäº¤å¤„æ–¹å¹¶è½åº“</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="mb-3">å¤„æ–¹æ˜ç»†</h5>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
              <tr>
                <th>è¯å“</th>
                <th>è§„æ ¼</th>
                <th class="text-end">å•ä»·</th>
                <th style="width:100px">æ•°é‡</th>
                <th class="text-end">å°è®¡</th>
                <th></th>
              </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between">
            <span class="pill">å…± <span id="itemCount">0</span> é¡¹</span>
            <strong>åˆè®¡ï¼šï¿¥<span id="total">0.00</span></strong>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="mb-3">æˆ‘çš„å¤„æ–¹</h5>
          <div id="myList" class="text-muted">åŠ è½½ä¸­â€¦</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function getToken(){
    const ls = localStorage.getItem('token');
    if(ls) return ls;
    const m = document.cookie.match(/(?:^|;\s*)token=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : null;
  }
  const token = getToken();

  let searchResults = [];
  let items = [];

  window.onload = function(){
    if(!token){alert('æœªç™»å½•');location.href='/login';return;}
    loadMy();
  }

  function money(n){
    const x = Number(n||0);
    return x.toFixed(2);
  }

  function calcTotal(){
    let t = 0;
    items.forEach(i=>t += (Number(i.unitPrice)||0) * (Number(i.quantity)||0));
    document.getElementById('total').textContent = money(t);
    document.getElementById('itemCount').textContent = String(items.length);
  }

  function renderItems(){
    const body = document.getElementById('itemsBody');
    body.innerHTML = '';
    items.forEach((it, idx)=>{
      const tr = document.createElement('tr');
      tr.className='item-row';
      tr.innerHTML = `
        <td><div><strong>${it.drugName}</strong></div><div class="pill">${it.drugCode}</div></td>
        <td class="pill">${it.specification||''}</td>
        <td class="text-end">ï¿¥${money(it.unitPrice)}</td>
        <td><input class="form-control form-control-sm" type="number" min="1" value="${it.quantity}" onchange="changeQty(${idx}, this.value)"></td>
        <td class="text-end">ï¿¥${money((Number(it.unitPrice)||0)*(Number(it.quantity)||0))}</td>
        <td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="removeItem(${idx})">åˆ é™¤</button></td>
      `;
      body.appendChild(tr);
    });
    calcTotal();
  }

  window.changeQty = function(idx, v){
    items[idx].quantity = Math.max(1, Number(v||1));
    renderItems();
  }
  window.removeItem = function(idx){
    items.splice(idx,1);
    renderItems();
  }

  async function searchDrug(){
    const kw = document.getElementById('drugKeyword').value.trim();
    const res = await fetch('/api/drug/search?keyword=' + encodeURIComponent(kw) + '&page=1&size=20');
    const data = await res.json();
    if(data.code!==200){alert(data.message||'æœç´¢å¤±è´¥');return;}
    searchResults = data.data || [];
    const sel = document.getElementById('drugSelect');
    sel.innerHTML = '';
    searchResults.forEach((d, i)=>{
      const o = document.createElement('option');
      o.value = String(i);
      o.textContent = `${d.drugName} | ${d.specification||''} | ï¿¥${money(d.price)} | ${d.drugCode}`;
      sel.appendChild(o);
    });
  }

  function addSelectedDrug(){
    const sel = document.getElementById('drugSelect');
    if(sel.value==='' || !searchResults[Number(sel.value)]){alert('è¯·é€‰æ‹©è¯å“');return;}
    const d = searchResults[Number(sel.value)];
    items.push({
      drugCode: d.drugCode,
      drugName: d.drugName,
      specification: d.specification,
      unitPrice: Number(d.price||0),
      quantity: 1,
      dosage: document.getElementById('dosage').value || null
    });
    renderItems();
  }

  function clearItems(){
    items = [];
    renderItems();
  }

  async function submitPrescription(){
    const patientId = Number(document.getElementById('patientId').value);
    if(!patientId){alert('è¯·è¾“å…¥æ‚£è€…ID');return;}
    if(items.length===0){alert('è¯·å…ˆåŠ å…¥è‡³å°‘ä¸€ä¸ªè¯å“');return;}

    const payload = {
      patientId: patientId,
      diagnosisId: null,
      items: items.map(i=>({
        drugCode: i.drugCode,
        drugName: i.drugName,
        dosage: i.dosage,
        quantity: i.quantity,
        unitPrice: i.unitPrice
      }))
    };

    const res = await fetch('/api/prescription',{
      method:'POST',
      headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.code===200){
      alert('å¤„æ–¹å·²åˆ›å»º');
      clearItems();
      loadMy();
    }else{
      alert(data.message||'åˆ›å»ºå¤±è´¥');
    }
  }

  async function loadMy(){
    const res = await fetch('/api/prescription/my',{
      headers:{'Authorization':'Bearer '+token}
    });
    const data = await res.json();
    const el = document.getElementById('myList');
    if(data.code!==200){
      el.innerHTML = `<div class="text-danger">åŠ è½½å¤±è´¥ï¼š${data.message||''}</div>`;
      return;
    }
    const list = data.data || [];
    if(list.length===0){
      el.innerHTML = '<div class="text-muted">æš‚æ— å¤„æ–¹</div>';
      return;
    }
    el.innerHTML = '<div class="list-group">' + list.map(p=>
      `<div class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <div><strong>å¤„æ–¹ #${p.id}</strong> <span class="pill">æ‚£è€…ID:${p.patientId}</span></div>
          <div class="pill">åˆè®¡ï¼šï¿¥${money(p.totalPrice)} | æ—¶é—´ï¼š${p.createTime||''}</div>
        </div>
        <button class="btn btn-sm btn-outline-primary" onclick="viewItems(${p.id})">æŸ¥çœ‹æ˜ç»†</button>
      </div>`
    ).join('') + '</div>';
  }

  async function viewItems(pid){
    const res = await fetch(`/api/prescription/${pid}/items`);
    const data = await res.json();
    if(data.code!==200){alert(data.message||'åŠ è½½æ˜ç»†å¤±è´¥');return;}
    const items = data.data || [];
    alert(items.map(i=>`${i.drugName} x${i.quantity} ï¿¥${money(i.unitPrice)} ç”¨æ³•:${i.dosage||''}`).join('\n'));
  }
</script>
</body>
</html>
