<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人设置 - 医生端</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 2rem;
            color: #333;
        }
        .container { max-width: 800px; }
        .card { 
            border: 0; 
            border-radius: 12px; 
            box-shadow: 0 6px 18px rgba(0,0,0,.08);
        }
        .avatar-preview {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,.15);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white mb-0">⚙️ 个人设置</h2>
        <a href="/doctor/home" class="btn btn-light">返回工作台</a>
    </div>

    <div class="card">
        <div class="card-body p-4">
            <div class="d-flex align-items-center gap-4 mb-4">
                <img id="avatarPreview" class="avatar-preview" src="/images/avatar-placeholder.svg" alt="头像">
                    <input type="file" id="avatarInput" accept="image/*" style="display:none">
                    <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('avatarInput').click()">更换头像</button>
                <div>
                    <h4 id="realNameDisplay" class="mb-0">加载中...</h4>
                    <div id="usernameDisplay" class="text-muted"></div>
                </div>
            </div>

            <form id="profileForm">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">真实姓名</label>
                        <input id="realName" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">手机号</label>
                        <input id="phone" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">邮箱</label>
                        <input id="email" type="email" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">性别</label>
                        <select id="gender" class="form-select">
                            <option value="0">男</option>
                            <option value="1">女</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">所属医院</label>
                        <input id="hospitalName" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">科室</label>
                        <input id="department" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">职称</label>
                        <input id="title" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">专长</label>
                        <input id="specialty" class="form-control">
                    </div>
                </div>

                <div class="d-flex gap-2 mt-4">
                    <button type="submit" class="btn btn-primary">保存修改</button>
                    <button type="button" class="btn btn-outline-danger ms-auto" onclick="logout()">退出登录</button>
                </div>
                <div id="msg" class="mt-3"></div>
            </form>
        </div>
    </div>
</div>

<script>
    function getToken() {
        const ls = localStorage.getItem('token');
        if (ls) return ls;
        const m = document.cookie.match(/(?:^|;\s*)token=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : null;
    }
    const token = getToken();

    window.onload = function() {
        if (!token) {
            alert('请先登录');
            location.href = '/login';
            return;
        }
        loadProfile();
    };

    async function loadProfile() {
        try {
            const res = await fetch('/api/doctor/info', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const result = await res.json();
            if (result.code !== 200) {
                showMsg('danger', result.message || '加载失败');
                return;
            }
            const doc = result.data;
            document.getElementById('realNameDisplay').textContent = doc.realName || '未设置姓名';
            document.getElementById('usernameDisplay').textContent = '@' + (doc.username || '');
            document.getElementById('avatarPreview').src = doc.avatarUrl || '/images/avatar-placeholder.svg';

            document.getElementById('realName').value = doc.realName || '';
            document.getElementById('phone').value = doc.phone || '';
            document.getElementById('email').value = doc.email || '';
            document.getElementById('gender').value = doc.gender != null ? doc.gender : '0';
            document.getElementById('hospitalName').value = doc.hospitalName || '';
            document.getElementById('department').value = doc.department || '';
            document.getElementById('title').value = doc.title || '';
            document.getElementById('specialty').value = doc.specialty || '';
        } catch (e) {
            showMsg('danger', '网络错误: ' + e.message);
        }
    }

    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            phone: document.getElementById('phone').value.trim(),
            email: document.getElementById('email').value.trim(),
            gender: parseInt(document.getElementById('gender').value),
            hospitalName: document.getElementById('hospitalName').value.trim(),
            department: document.getElementById('department').value.trim(),
            title: document.getElementById('title').value.trim(),
            specialty: document.getElementById('specialty').value.trim()
        };
        
        // 基本验证
        if (formData.phone && !/^1[3-9]\d{9}$/.test(formData.phone)) {
            showMsg('danger', '手机号格式不正确');
            return;
        }
        if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
            showMsg('danger', '邮箱格式不正确');
            return;
        }
        
        try {
            showMsg('info', '保存中...');
            const res = await fetch('/api/doctor/info', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(formData)
            });
            
            const result = await res.json();
            if (result.code === 200) {
                showMsg('success', '保存成功！');
                // 更新显示的名称（如果修改了医院或科室）
                setTimeout(() => {
                    loadProfile(); // 重新加载数据
                }, 1000);
            } else {
                showMsg('danger', result.message || '保存失败');
            }
        } catch (e) {
            showMsg('danger', '网络错误: ' + e.message);
        }
    });

    function logout() {
        if (confirm('确定退出登录吗?')) {
            localStorage.clear();
            document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            location.href = '/login';
        }
    }

    function showMsg(type, text) {
        const el = document.getElementById('msg');
        el.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
    }
    // 头像上传
document.getElementById('avatarInput').addEventListener('change', async function (e) {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
        showMsg('danger', '图片不能超过5MB'); return;
    }
    if (!file.type.startsWith('image/')) {
        showMsg('danger', '请选择图片文件'); return;
    }

    const fd = new FormData();
    fd.append('file', file);
    try {
        showMsg('info', '上传中...');
        const r = await fetch('/api/doctor/avatar', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token },
            body: fd
        });
        const d = await r.json();
        if (d.code !== 200) {
            showMsg('danger', d.message || '上传失败'); return;
        }
        // 更新头像并重新拉个人信息
        document.getElementById('avatarPreview').src = d.data + '?t=' + Date.now();
        showMsg('success', '上传成功');
        setTimeout(loadProfile, 300);
    } catch (err) {
        showMsg('danger', '上传失败: ' + err.message);
    }
});
</script>
</body>
</html>