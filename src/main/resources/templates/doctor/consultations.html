<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—®è¯Šå·¥ä½œå° - åŒ»ç”Ÿç«¯</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body{background:#f7f8fa;padding:1.5rem;}
        .card{border:0;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
        .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
        .split{display:grid;grid-template-columns:420px 1fr;gap:1rem;align-items:start}
        @media (max-width: 992px){
            .split{grid-template-columns:1fr}
        }
        .list-scroll{max-height:70vh;overflow:auto}
        .muted{color:#6c757d}
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">ğŸ©º é—®è¯Šå·¥ä½œå°</h3>
        <div>
            <button class="btn btn-outline-secondary" onclick="history.back()">è¿”å›</button>
            <button class="btn btn-primary" onclick="loadData()">åˆ·æ–°</button>
        </div>
    </div>

    <div class="split">
        <!-- å·¦ä¾§ï¼šåˆ—è¡¨ä¸ç­›é€‰ -->
        <div>
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-2 align-items-center">
                        <div class="col-12">
                            <input id="searchInput" class="form-control" placeholder="ğŸ” æ‚£è€…å§“å/å…³é”®è¯">
                        </div>
                        <div class="col-12">
                            <input type="date" id="dateFilter" class="form-control">
                        </div>
                        <div class="col-12 d-flex gap-2">
                            <button class="btn btn-primary flex-fill" onclick="applyFilter()">ç­›é€‰</button>
                            <button class="btn btn-outline-secondary flex-fill" onclick="resetFilter()">é‡ç½®</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body p-0">
                    <div id="listContainer" class="list-group list-scroll"></div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šè¯¦æƒ…ä¸å¤„ç† -->
        <div>
            <div class="card">
                <div class="card-body p-4">
                    <div id="emptyDetail" class="text-center muted py-5">
                        <div style="font-size:48px;">ğŸ“‹</div>
                        <div class="mt-2">è¯·é€‰æ‹©å·¦ä¾§ä¸€æ¡é¢„çº¦å¼€å§‹é—®è¯Š</div>
                    </div>

                    <div id="detailPanel" style="display:none;">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <div class="muted">é¢„çº¦IDï¼š<span id="dAppointmentId"></span></div>
                                <div class="fw-bold fs-5" id="dPatientName"></div>
                                <div class="muted" id="dTime"></div>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="delCurrent()">åˆ é™¤é¢„çº¦</button>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label">åŒ»ç”Ÿè¯Šæ–­</label>
                            <textarea id="diagnosis" class="form-control" rows="4" placeholder="è¯·è¾“å…¥è¯Šæ–­ç»“è®º..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">åŒ»å˜±å»ºè®®</label>
                            <textarea id="advice" class="form-control" rows="4" placeholder="è¯·è¾“å…¥åŒ»å˜±å»ºè®®..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ”¶è´¹é¡¹ç›®</label>
                            <select id="itemSel" class="form-select">
                                <option value="">è¯·é€‰æ‹©æ”¶è´¹é¡¹ç›®</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">å¤„æ–¹æ‘˜è¦ï¼ˆå¯é€‰ï¼‰</label>
                            <textarea id="prescription" class="form-control" rows="3" placeholder="å¯å¡«å†™å¤„æ–¹æ‘˜è¦..."></textarea>
                        </div>
                        <button id="submitBtn" class="btn btn-success w-100" onclick="finishConsultation()">
                            <span id="submitText">ç»“æŸé—®è¯Šå¹¶ç”Ÿæˆæ”¯ä»˜å•</span>
                            <span id="submitSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function getToken(){
        const ls = localStorage.getItem('token');
        if(ls) return ls;
        const m = document.cookie.match(/(?:^|;\s*)token=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : null;
    }

    const token = getToken();
    let allData = [];
    let currentAppointmentId = null;

    window.onload = async function(){
        if(!token){alert('æœªç™»å½•');location.href='/login';return;}
        await loadItems();
        await loadData();
    };

    async function loadItems(){
        try{
            const resp = await fetch('/api/catalog/non-drug-items');
            const json = await resp.json();
            const sel = document.getElementById('itemSel');
            (json.data||[]).forEach(it=>{
                const opt=document.createElement('option');
                opt.value=it.itemName;
                opt.dataset.price=it.unitPrice;
                opt.textContent=`${it.itemName} (ï¿¥${Number(it.unitPrice).toFixed(2)})`;
                sel.appendChild(opt);
            });
        }catch(e){
            console.error('åŠ è½½æ”¶è´¹é¡¹ç›®å¤±è´¥',e);
        }
    }

    async function loadData(){
        const res = await fetch('/api/doctor/appointment/my',{headers:{'Authorization':'Bearer '+token}});
        const data = await res.json();
        if(data.code===200){
            allData = data.data || [];
            renderList();
        }else{
            alert(data.message||'åŠ è½½å¤±è´¥');
        }
    }

    function applyFilter(){renderList()}

    function resetFilter(){
        document.getElementById('searchInput').value='';
        document.getElementById('dateFilter').value='';
        renderList();
    }

    function renderList(){
        const kw=document.getElementById('searchInput').value.trim().toLowerCase();
        const date=document.getElementById('dateFilter').value;

        const list=allData.filter(it=>{
            const name=(it.patientName||'').toLowerCase();
            if(kw && !name.includes(kw)) return false;
            if(date){
                const d = it.appointTime ? new Date(it.appointTime).toISOString().slice(0,10) : '';
                if(d!==date) return false;
            }
            return true;
        });

        const c=document.getElementById('listContainer');
        if(list.length===0){
            c.innerHTML='<div class="text-muted text-center py-5">æš‚æ— é¢„çº¦è®°å½•</div>';
            return;
        }

        c.innerHTML = '';
        list.forEach(it=>{
            const aId = it.id;
            const el = document.createElement('button');
            el.type='button';
            el.className='list-group-item list-group-item-action d-flex gap-3 align-items-start';
            el.onclick=()=>selectAppointment(it);
            el.innerHTML = `
                <img class="avatar" src="/images/avatar-placeholder.svg" alt="å¤´åƒ">
                <div class="flex-fill text-start">
                    <div class="d-flex w-100 justify-content-between">
                        <strong>${it.patientName||('æ‚£è€…ID:'+it.patientId)}</strong>
                        <small class="text-muted">${format(it.appointTime)}</small>
                    </div>
                    <div class="text-muted mt-1">ç§‘å®¤ID: ${it.deptId}</div>
                </div>
            `;
            c.appendChild(el);
        });
    }

    function selectAppointment(it){
        currentAppointmentId = it.id;
        document.getElementById('emptyDetail').style.display='none';
        document.getElementById('detailPanel').style.display='block';

        document.getElementById('dAppointmentId').textContent = it.id;
        document.getElementById('dPatientName').textContent = it.patientName || ('æ‚£è€…ID:'+it.patientId);
        document.getElementById('dTime').textContent = 'é¢„çº¦æ—¶é—´ï¼š' + format(it.appointTime);
    }

    async function delCurrent(){
        if(!currentAppointmentId){alert('æœªé€‰æ‹©é¢„çº¦');return;}
        if(!confirm('ç¡®è®¤åˆ é™¤è¯¥é¢„çº¦ï¼Ÿ')) return;
        const r = await fetch('/api/appointment/'+currentAppointmentId,{method:'DELETE',headers:{'Authorization':'Bearer '+token}});
        const j = await r.json();
        alert(j.message||'å·²åˆ é™¤');
        if(j.code===200){
            currentAppointmentId=null;
            document.getElementById('detailPanel').style.display='none';
            document.getElementById('emptyDetail').style.display='block';
            await loadData();
        }
    }

    async function finishConsultation(){
        if(!currentAppointmentId){alert('è¯·å…ˆé€‰æ‹©ä¸€æ¡é¢„çº¦');return;}
        const itemName=document.getElementById('itemSel').value;
        if(!itemName){alert('è¯·é€‰æ‹©æ”¶è´¹é¡¹ç›®');return;}

        const btn=document.getElementById('submitBtn');
        document.getElementById('submitText').classList.add('d-none');
        document.getElementById('submitSpinner').classList.remove('d-none');
        btn.disabled=true;
        try{
            const res = await fetch(`/api/payment/create-from-appointment/${currentAppointmentId}?itemName=`+encodeURIComponent(itemName),{
                method:'POST',
                headers:{'Authorization':'Bearer '+token}
            });
            const data = await res.json();
            if(data.code===200){
                alert('å·²ç”Ÿæˆæ”¯ä»˜å•ï¼Œæ”¯ä»˜å•IDï¼š'+data.data.id);
            }else{
                alert(data.message||'ç”Ÿæˆæ”¯ä»˜å•å¤±è´¥');
            }
        }catch(err){
            console.error(err);
            alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        }finally{
            document.getElementById('submitText').classList.remove('d-none');
            document.getElementById('submitSpinner').classList.add('d-none');
            btn.disabled=false;
        }
    }

    function format(ts){
        if(!ts) return '-';
        return new Date(ts).toLocaleString();
    }
</script>
</body>
</html>
