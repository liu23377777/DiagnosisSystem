<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èˆŒè¯Šå®¡æ ¸ç®¡ç† - åŒ»ç”Ÿç«¯</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', 'PingFang SC', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    /* å¤´éƒ¨ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }

    .header h1 {
      color: #667eea;
      font-size: 28px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    /* Tabåˆ‡æ¢ */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #666;
      font-size: 16px;
      position: relative;
      transition: all 0.3s;
    }

    .tab:hover {
      color: #667eea;
    }

    .tab.active {
      color: #667eea;
      font-weight: bold;
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: #667eea;
    }

    /* æœç´¢æ  */
    .search-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .search-input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .date-filter {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    /* åˆ—è¡¨å®¹å™¨ */
    .list-container {
      min-height: 400px;
    }

    .tongue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    /* å¡ç‰‡æ ·å¼ */
    .tongue-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s;
      cursor: pointer;
    }

    .tongue-card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      transform: translateY(-5px);
    }

    .card-image {
      width: 100%;
      height: 220px;
      object-fit: cover;
      background: #f0f0f0;
    }

    .card-content {
      padding: 15px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .patient-name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-reviewed {
      background: #d4edda;
      color: #155724;
    }

    .card-info {
      margin-bottom: 8px;
      font-size: 14px;
      color: #666;
    }

    .card-info strong {
      color: #333;
    }

    .card-footer {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      gap: 10px;
    }

    .btn-small {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-review {
      background: #667eea;
      color: white;
    }

    .btn-review:hover {
      background: #5568d3;
    }

    .btn-detail {
      background: #f0f0f0;
      color: #333;
    }

    .btn-detail:hover {
      background: #e0e0e0;
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    /* åˆ†é¡µ */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 30px;
    }

    .page-btn {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .page-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }

    .page-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    /* æ¨¡æ€æ¡† */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      margin: 30px auto;
      border-radius: 15px;
      overflow: hidden;
      animation: slideDown 0.3s;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 20px;
      margin: 0;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      line-height: 1;
      opacity: 0.8;
      transition: opacity 0.3s;
    }

    .close-btn:hover {
      opacity: 1;
    }

    .modal-body {
      padding: 25px;
      max-height: calc(90vh - 80px);
      overflow-y: auto;
    }

    .detail-section {
      margin-bottom: 25px;
    }

    .detail-section h4 {
      color: #667eea;
      margin-bottom: 12px;
      font-size: 16px;
      border-left: 4px solid #667eea;
      padding-left: 10px;
    }

    .detail-image {
      width: 100%;
      max-height: 350px;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .detail-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .detail-item label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .detail-item .value {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
    }

    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- å¤´éƒ¨ -->
  <div class="header">
    <h1>ğŸ©º èˆŒè¯Šå®¡æ ¸ç®¡ç†</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="location.href='/doctor/home'">è¿”å›é¦–é¡µ</button>
      <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
    </div>
  </div>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <div class="stats">
    <div class="stat-card">
      <div class="stat-value" id="totalPending">0</div>
      <div class="stat-label">å¾…å®¡æ ¸</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalReviewed">0</div>
      <div class="stat-label">å·²å®¡æ ¸</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="todayReviewed">0</div>
      <div class="stat-label">ä»Šæ—¥å®¡æ ¸</div>
    </div>
  </div>

  <!-- Tabåˆ‡æ¢ -->
  <div class="tabs">
    <button class="tab active" data-tab="pending" onclick="switchTab('pending')">
      å¾…å®¡æ ¸ (<span id="pendingCount">0</span>)
    </button>
    <button class="tab" data-tab="reviewed" onclick="switchTab('reviewed')">
      å·²å®¡æ ¸ (<span id="reviewedCount">0</span>)
    </button>
  </div>

  <!-- æœç´¢æ  -->
  <div class="search-bar">
    <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœç´¢æ‚£è€…å§“å...">
    <input type="date" class="date-filter" id="dateFilter">
    <button class="btn btn-primary" onclick="applyFilters()">ç­›é€‰</button>
    <button class="btn btn-secondary" onclick="clearFilters()">æ¸…ç©º</button>
  </div>

  <!-- åˆ—è¡¨å®¹å™¨ -->
  <div class="list-container">
    <div id="loadingIndicator" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>åŠ è½½ä¸­...</p>
    </div>
    <div id="tongueList" class="tongue-grid"></div>
  </div>

  <!-- åˆ†é¡µ -->
  <div class="pagination" id="pagination"></div>
</div>

<!-- å®¡æ ¸æ¨¡æ€æ¡† -->
<div id="reviewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“‹ èˆŒè¯Šå®¡æ ¸</h3>
      <button class="close-btn" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-section">
        <h4>æ‚£è€…ä¿¡æ¯</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <label>å§“å</label>
            <div class="value" id="modalPatientName">-</div>
          </div>
          <div class="detail-item">
            <label>ä¸Šä¼ æ—¶é—´</label>
            <div class="value" id="modalCreateTime">-</div>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h4>èˆŒè±¡å›¾ç‰‡</h4>
        <img id="modalImage" class="detail-image" src="" alt="èˆŒè±¡">
      </div>

      <div class="detail-section">
        <h4>AIåˆ†æç»“æœ</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <label>èˆŒè‰²</label>
            <div class="value" id="modalColor">-</div>
          </div>
          <div class="detail-item">
            <label>èˆŒå½¢</label>
            <div class="value" id="modalShape">-</div>
          </div>
          <div class="detail-item">
            <label>èˆŒè‹”</label>
            <div class="value" id="modalCoating">-</div>
          </div>
          <div class="detail-item">
            <label>è¯å‹</label>
            <div class="value" id="modalSyndrome">-</div>
          </div>
        </div>
        <div class="detail-item" style="margin-top: 15px;">
          <label>AIå»ºè®®</label>
          <div class="value" id="modalAdvice">-</div>
        </div>
      </div>

      <div class="detail-section" id="reviewSection">
        <h4>åŒ»ç”Ÿå®¡æ ¸</h4>
        <div class="form-group">
          <label>æœ€ç»ˆè¯Šæ–­ <span style="color: red;">*</span></label>
          <textarea id="finalSyndrome" placeholder="è¯·è¾“å…¥æ‚¨çš„è¯Šæ–­ç»“æœ(ä¾‹å¦‚:æ°”è™šè¡€ç˜€è¯)"></textarea>
        </div>
        <div class="form-group">
          <label>åŒ»å˜±å»ºè®® <span style="color: red;">*</span></label>
          <textarea id="finalAdvice" placeholder="è¯·è¾“å…¥åŒ»å˜±å’Œç”Ÿæ´»å»ºè®®"></textarea>
        </div>
        <button class="btn btn-primary" style="width: 100%;" onclick="submitReview()">
          âœ… æäº¤å®¡æ ¸
        </button>
      </div>

      <div class="detail-section" id="reviewedSection" style="display: none;">
        <h4>å®¡æ ¸è®°å½•</h4>
        <div class="detail-item">
          <label>å®¡æ ¸åŒ»ç”Ÿ</label>
          <div class="value" id="modalDoctorName">-</div>
        </div>
        <div class="detail-item" style="margin-top: 15px;">
          <label>æœ€ç»ˆè¯Šæ–­</label>
          <div class="value" id="modalFinalSyndrome">-</div>
        </div>
        <div class="detail-item" style="margin-top: 15px;">
          <label>åŒ»å˜±å»ºè®®</label>
          <div class="value" id="modalFinalAdvice">-</div>
        </div>
        <div class="detail-item" style="margin-top: 15px;">
          <label>å®¡æ ¸æ—¶é—´</label>
          <div class="value" id="modalReviewTime">-</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // å…¨å±€å˜é‡
  const token = localStorage.getItem('token');
  let currentTab = 'pending';
  let currentTongueId = null;
  let allData = { pending: [], reviewed: [] };
  let filteredData = [];
  let currentPage = 1;
  const pageSize = 9;

  // é¡µé¢åŠ è½½
  window.onload = function() {
    if (!token) {
      alert('è¯·å…ˆç™»å½•');
      window.location.href = '/login';
      return;
    }
    loadAllData();
  };

  // åŠ è½½æ‰€æœ‰æ•°æ®
  async function loadAllData() {
    showLoading(true);
    try {
      // å¹¶è¡ŒåŠ è½½å¾…å®¡æ ¸å’Œå·²å®¡æ ¸æ•°æ®
      const [pendingRes, reviewedRes] = await Promise.all([
        fetch('/api/doctor/tongue-review/pending', {
          headers: { 'Authorization': `Bearer ${token}` }
        }),
        fetch('/api/doctor/tongue-review/my-reviews', {
          headers: { 'Authorization': `Bearer ${token}` }
        })
      ]);

      const pendingResult = await pendingRes.json();
      const reviewedResult = await reviewedRes.json();

      if (pendingResult.code === 200) {
        allData.pending = pendingResult.data || [];
      }
      if (reviewedResult.code === 200) {
        allData.reviewed = reviewedResult.data || [];
      }

      updateStats();
      renderCurrentTab();
    } catch (error) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
      showError('åŠ è½½æ•°æ®å¤±è´¥,è¯·ç¨åé‡è¯•');
    } finally {
      showLoading(false);
    }
  }

  // æ›´æ–°ç»Ÿè®¡
  function updateStats() {
    document.getElementById('totalPending').textContent = allData.pending.length;
    document.getElementById('totalReviewed').textContent = allData.reviewed.length;
    document.getElementById('pendingCount').textContent = allData.pending.length;
    document.getElementById('reviewedCount').textContent = allData.reviewed.length;

    // è®¡ç®—ä»Šæ—¥å®¡æ ¸
    const today = new Date().toDateString();
    const todayCount = allData.reviewed.filter(item => {
      if (!item.reviewTime) return false;
      return new Date(item.reviewTime).toDateString() === today;
    }).length;
    document.getElementById('todayReviewed').textContent = todayCount;
  }

  // åˆ‡æ¢Tab
  function switchTab(tab) {
    currentTab = tab;
    currentPage = 1;

    // æ›´æ–°Tabæ ·å¼
    document.querySelectorAll('.tab').forEach(t => {
      t.classList.remove('active');
      if (t.dataset.tab === tab) {
        t.classList.add('active');
      }
    });

    renderCurrentTab();
  }

  // æ¸²æŸ“å½“å‰Tab
  function renderCurrentTab() {
    const data = allData[currentTab] || [];
    filteredData = applyCurrentFilters(data);
    renderList();
  }

  // åº”ç”¨ç­›é€‰
  function applyCurrentFilters(data) {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;

    return data.filter(item => {
      // æœç´¢ç­›é€‰
      if (searchText && item.patientName && !item.patientName.toLowerCase().includes(searchText)) {
        return false;
      }

      // æ—¥æœŸç­›é€‰
      if (dateFilter) {
        const itemDate = new Date(item.createTime).toISOString().split('T')[0];
        if (itemDate !== dateFilter) {
          return false;
        }
      }

      return true;
    });
  }

  // åº”ç”¨ç­›é€‰æŒ‰é’®
  function applyFilters() {
    currentPage = 1;
    renderCurrentTab();
  }

  // æ¸…ç©ºç­›é€‰
  function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('dateFilter').value = '';
    currentPage = 1;
    renderCurrentTab();
  }

  // æ¸²æŸ“åˆ—è¡¨
  function renderList() {
    const container = document.getElementById('tongueList');

    if (filteredData.length === 0) {
      container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <p>${currentTab === 'pending' ? 'æš‚æ— å¾…å®¡æ ¸è®°å½•' : 'æš‚æ— å·²å®¡æ ¸è®°å½•'}</p>
                </div>
            `;
      document.getElementById('pagination').innerHTML = '';
      return;
    }

    // åˆ†é¡µ
    const totalPages = Math.ceil(filteredData.length / pageSize);
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageData = filteredData.slice(start, end);

    // æ¸²æŸ“å¡ç‰‡
    let html = '';
    pageData.forEach(item => {
      html += `
                <div class="tongue-card" onclick="openDetailModal(${item.id})">
                    <img class="card-image" src="${item.imageUrl || '/images/tongue-placeholder.png'}"
                         alt="èˆŒè±¡" onerror="this.src='/images/tongue-placeholder.png'">
                    <div class="card-content">
                        <div class="card-header">
                            <div class="patient-name">${item.patientName || 'æœªçŸ¥æ‚£è€…'}</div>
                            <span class="status-badge ${item.status === 0 ? 'status-pending' : 'status-reviewed'}">
                                ${item.status === 0 ? 'å¾…å®¡æ ¸' : 'å·²å®¡æ ¸'}
                            </span>
                        </div>
                        <div class="card-info">
                            <strong>AIè¯å‹:</strong> ${item.aiSyndrome || 'æ— '}
                        </div>
                        <div class="card-info">
                            <strong>èˆŒè‰²:</strong> ${item.tongueColor || 'æœªçŸ¥'}
                            <strong>èˆŒå½¢:</strong> ${item.tongueShape || 'æœªçŸ¥'}
                        </div>
                        <div class="card-info">
                            <strong>ä¸Šä¼ æ—¶é—´:</strong> ${formatDate(item.createTime)}
                        </div>
                        ${item.reviewTime ? `
                        <div class="card-info">
                            <strong>å®¡æ ¸æ—¶é—´:</strong> ${formatDate(item.reviewTime)}
                        </div>
                        ` : ''}
                        <div class="card-footer">
                            ${item.status === 0
              ? `<button class="btn-small btn-review" onclick="event.stopPropagation(); openReviewModal(${item.id})">ç«‹å³å®¡æ ¸</button>`
              : `<button class="btn-small btn-detail" onclick="event.stopPropagation(); openDetailModal(${item.id})">æŸ¥çœ‹è¯¦æƒ…</button>`
      }
                        </div>
                    </div>
                </div>
            `;
    });

    container.innerHTML = html;

    // æ¸²æŸ“åˆ†é¡µ
    renderPagination(totalPages);
  }

  // æ¸²æŸ“åˆ†é¡µ
  function renderPagination(totalPages) {
    const container = document.getElementById('pagination');
    if (totalPages <= 1) {
      container.innerHTML = '';
      return;
    }

    let html = '';

    // ä¸Šä¸€é¡µ
    html += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">â€¹</button>`;

    // é¡µç 
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
      } else if (i === currentPage - 3 || i === currentPage + 3) {
        html += `<span class="page-btn" disabled>...</span>`;
      }
    }

    // ä¸‹ä¸€é¡µ
    html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">â€º</button>`;

    container.innerHTML = html;
  }

  // åˆ‡æ¢é¡µç 
  function changePage(page) {
    currentPage = page;
    renderList();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // æ‰“å¼€å®¡æ ¸æ¨¡æ€æ¡†
  async function openReviewModal(tongueId) {
    currentTongueId = tongueId;
    const data = await fetchTongueDetail(tongueId);
    if (!data) return;

    fillModalData(data, true);
    document.getElementById('reviewModal').style.display = 'block';
  }

  // æ‰“å¼€è¯¦æƒ…æ¨¡æ€æ¡†
  async function openDetailModal(tongueId) {
    currentTongueId = tongueId;
    const data = await fetchTongueDetail(tongueId);
    if (!data) return;

    fillModalData(data, false);
    document.getElementById('reviewModal').style.display = 'block';
  }

  // è·å–èˆŒè¯Šè¯¦æƒ…
  async function fetchTongueDetail(tongueId) {
    try {
      const response = await fetch(`/api/doctor/tongue-review/detail/${tongueId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const result = await response.json();

      if (result.code === 200) {
        return result.data;
      } else {
        alert('åŠ è½½è¯¦æƒ…å¤±è´¥: ' + result.message);
        return null;
      }
    } catch (error) {
      console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
      alert('ç½‘ç»œé”™è¯¯,è¯·ç¨åé‡è¯•');
      return null;
    }
  }

  // å¡«å……æ¨¡æ€æ¡†æ•°æ®
  function fillModalData(data, isReviewMode) {
    document.getElementById('modalPatientName').textContent = data.patientName || 'æœªçŸ¥';
    document.getElementById('modalCreateTime').textContent = formatDateTime(data.createTime);
    document.getElementById('modalImage').src = data.imageUrl || '';
    document.getElementById('modalColor').textContent = data.tongueColor || 'æœªçŸ¥';
    document.getElementById('modalShape').textContent = data.tongueShape || 'æœªçŸ¥';
    document.getElementById('modalCoating').textContent = data.coating || 'æœªçŸ¥';
    document.getElementById('modalSyndrome').textContent = data.aiSyndrome || 'æ— ';
    document.getElementById('modalAdvice').textContent = data.aiAdvice || 'æ— ';

      if (isReviewMode) {
        document.getElementById('reviewSection').style.display = 'block';
        document.getElementById('reviewedSection').style.display = 'none';
        document.getElementById('finalSyndrome').value = '';
        document.getElementById('finalAdvice').value = '';
      } else {
        document.getElementById('reviewSection').style.display = 'none';
        document.getElementById('reviewedSection').style.display = 'block';
        document.getElementById('modalDoctorName').textContent = data.doctorName || 'æœªçŸ¥';
        document.getElementById('modalFinalSyndrome').textContent = data.finalSyndrome || 'æ— ';
        document.getElementById('modalFinalAdvice').textContent = data.finalAdvice || 'æ— ';
        document.getElementById('modalReviewTime').textContent = formatDateTime(data.reviewTime);
      }
    }

    // æäº¤å®¡æ ¸
    async function submitReview() {
      const finalSyndrome = document.getElementById('finalSyndrome').value.trim();
      const finalAdvice = document.getElementById('finalAdvice').value.trim();

      if (!finalSyndrome) {
        alert('âš ï¸ è¯·å¡«å†™æœ€ç»ˆè¯Šæ–­');
        return;
      }

      if (!finalAdvice) {
        alert('âš ï¸ è¯·å¡«å†™åŒ»å˜±å»ºè®®');
        return;
      }

      if (!confirm('ç¡®å®šæäº¤å®¡æ ¸å—?æäº¤åå°†æ— æ³•ä¿®æ”¹ã€‚')) {
        return;
      }

      try {
        const response = await fetch('/api/doctor/tongue-review/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            tongueId: currentTongueId,
            finalSyndrome: finalSyndrome,
            finalAdvice: finalAdvice
          })
        });

        const result = await response.json();

        if (result.code === 200) {
          alert('âœ… å®¡æ ¸æäº¤æˆåŠŸ!');
          closeModal();
          await loadAllData(); // é‡æ–°åŠ è½½æ•°æ®
        } else {
          alert('âŒ å®¡æ ¸å¤±è´¥: ' + result.message);
        }
      } catch (error) {
        console.error('æäº¤å®¡æ ¸å¤±è´¥:', error);
        alert('âŒ ç½‘ç»œé”™è¯¯,è¯·ç¨åé‡è¯•');
      }
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
      document.getElementById('reviewModal').style.display = 'none';
      currentTongueId = null;
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
      const modal = document.getElementById('reviewModal');
      if (event.target === modal) {
        closeModal();
      }
    }

    // åˆ·æ–°æ•°æ®
    async function refreshData() {
      await loadAllData();
      alert('âœ… æ•°æ®å·²åˆ·æ–°');
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading(show) {
      document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
      document.getElementById('tongueList').style.display = show ? 'none' : 'grid';
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      const container = document.getElementById('tongueList');
      container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">âš ï¸</div>
                <p style="color: #dc3545;">${message}</p>
                <button class="btn btn-primary" onclick="loadAllData()">é‡æ–°åŠ è½½</button>
            </div>
        `;
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
    function formatDateTime(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      const minute = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hour}:${minute}`;
    }

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
      // ESC å…³é—­æ¨¡æ€æ¡†
      if (e.key === 'Escape') {
        closeModal();
      }

      // Enter æœç´¢
      if (e.key === 'Enter' && document.getElementById('searchInput') === document.activeElement) {
        applyFilters();
      }
    });
</script>
</body>
</html>
