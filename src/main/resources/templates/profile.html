<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸ªäººä¿¡æ¯ - ä¸­åŒ»è¯Šæ–­ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      color: #667eea;
      margin: 0;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-success {
      background: #2ed573;
      color: white;
    }

    .btn-success:hover {
      background: #26c462;
    }

    .content {
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .profile-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 30px;
      border-bottom: 1px solid #f0f0f0;
    }

    .avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
      font-weight: bold;
      border: 4px solid white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .profile-name {
      font-size: 24px;
      color: #333;
      margin-bottom: 5px;
    }

    .profile-username {
      color: #999;
      font-size: 14px;
    }

    .form-section {
      margin-bottom: 30px;
    }

    .form-section h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #333;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #f0f5f0;
    }

    .message {
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .message-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .statistics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-card .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-card .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ‘¤ ä¸ªäººä¿¡æ¯</h1>
    <a href="/api/patient/home" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
  </div>

  <div class="content">
    <div id="loading" class="loading">åŠ è½½ä¸­...</div>

    <div id="profileContent" style="display: none;">
      <div class="profile-header">
        <div class="avatar" id="avatar">
          <span id="avatarText">ğŸ‘¤</span>
        </div>
        <div class="profile-name" id="real_name">åŠ è½½ä¸­...</div>
        <div class="profile-username" id="username">@username</div>
      </div>

      <div id="successMessage" class="message message-success"></div>
      <div id="errorMessage" class="message message-error"></div>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="statistics" id="statistics">
        <div class="stat-card">
          <div class="stat-value" id="totalDiagnoses">0</div>
          <div class="stat-label">æ€»è¯Šæ–­æ¬¡æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="thisMonth">0</div>
          <div class="stat-label">æœ¬æœˆè¯Šæ–­</div>
        </div>
      </div>

      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <div class="form-section">
        <h2>åŸºæœ¬ä¿¡æ¯</h2>
        <form id="infoForm">
          <div class="form-row">
            <div class="form-group">
              <label for="realName">çœŸå®å§“å</label>
              <input type="text" id="realName" name="realName" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
            </div>
            <div class="form-group">
              <label for="username">ç”¨æˆ·å</label>
              <input type="text" id="username" name="username" disabled>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="phone">æ‰‹æœºå·</label>
              <input type="tel" id="phone" name="phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
            </div>
            <div class="form-group">
              <label for="email">é‚®ç®±</label>
              <input type="email" id="email" name="email" placeholder="è¯·è¾“å…¥é‚®ç®±">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="gender">æ€§åˆ«</label>
              <select id="gender" name="gender">
                <option value="">è¯·é€‰æ‹©</option>
                <option value="0">å¥³</option>
                <option value="1">ç”·</option>
              </select>
            </div>
            <div class="form-group">
              <label for="birthDate">å‡ºç”Ÿæ—¥æœŸ</label>
              <input type="date" id="birthDate" name="birthDate">
            </div>
          </div>

          <div class="button-group">
            <button type="button" class="btn btn-primary" onclick="saveInfo()">ä¿å­˜ä¿®æ”¹</button>
          </div>
        </form>
      </div>

      <!-- ä¿®æ”¹å¯†ç  -->
      <div class="form-section">
        <h2>ä¿®æ”¹å¯†ç </h2>
        <form id="passwordForm">
          <div class="form-group">
            <label for="oldPassword">å½“å‰å¯†ç </label>
            <input type="password" id="oldPassword" name="oldPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ">
          </div>
          <div class="form-group">
            <label for="newPassword">æ–°å¯†ç </label>
            <input type="password" id="newPassword" name="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
          </div>
          <div class="form-group">
            <label for="confirmPassword">ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
          </div>
          <div class="button-group">
            <button type="button" class="btn btn-success" onclick="changePassword()">ä¿®æ”¹å¯†ç </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  window.onload = function() {
    checkLogin();
    loadUserInfo();
    loadStatistics();
  };

  function checkLogin() {
    const userId = localStorage.getItem('userId');
    const token = localStorage.getItem('token');
    if (!userId || !token) {
      alert('è¯·å…ˆç™»å½•');
      location.href = '/login';
    }
  }

  async function loadUserInfo() {
    try {
      const userId = localStorage.getItem('userId');
      const token = localStorage.getItem('token');

      const response = await fetch(`/api/patient/info?userId=${userId}`, {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });

      const data = await response.json();

      if (data.code === 200) {
        const user = data.data;

        // å¡«å……è¡¨å•
        document.getElementById('realName').value = user.realName || '';
        document.getElementById('username').value = user.username || '';
        document.getElementById('phone').value = user.phone || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('gender').value = user.gender !== null && user.gender !== undefined ? user.gender.toString() : '';
        document.getElementById('birthDate').value = formatDate(user.birthDate) || '';

        // æ›´æ–°æ˜¾ç¤º
        document.querySelector('.profile-name').textContent = user.realName || user.username || 'æœªè®¾ç½®';
        document.querySelector('.profile-username').textContent = '@' + user.username;

        // è®¾ç½®å¤´åƒæ–‡å­—
        const avatarText = document.getElementById('avatarText');
        if (user.realName) {
          avatarText.textContent = user.realName.charAt(0).toUpperCase();
        } else if (user.username) {
          avatarText.textContent = user.username.charAt(0).toUpperCase();
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('profileContent').style.display = 'block';
      } else {
        showError('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + data.message);
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
      showError('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      document.getElementById('loading').style.display = 'none';
    }
  }

  async function loadStatistics() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch('/api/patient/tongue/statistics', {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });

      const data = await response.json();

      if (data.code === 200 && data.data) {
        const stats = data.data;
        document.getElementById('totalDiagnoses').textContent = stats.totalDiagnoses || 0;
        document.getElementById('thisMonth').textContent = stats.thisMonth || 0;
      }
    } catch (error) {
      console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯é”™è¯¯:', error);
      // ç»Ÿè®¡ä¿¡æ¯åŠ è½½å¤±è´¥ä¸å½±å“ä¸»åŠŸèƒ½ï¼Œé™é»˜å¤„ç†
    }
  }

  async function saveInfo() {
    const userId = localStorage.getItem('userId');
    const token = localStorage.getItem('token');

    const formData = {
      id: userId,
      realName: document.getElementById('realName').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      gender: document.getElementById('gender').value ? parseInt(document.getElementById('gender').value) : null,
      birthDate: document.getElementById('birthDate').value || null
    };

    try {
      const response = await fetch('/api/patient/update', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(formData)
      });

      const data = await response.json();

      if (data.code === 200) {
        showSuccess('ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
        await loadUserInfo();
      } else {
        showError('æ›´æ–°å¤±è´¥: ' + data.message);
      }
    } catch (error) {
      console.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error);
      showError('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  }

  async function changePassword() {
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (!oldPassword || !newPassword || !confirmPassword) {
      showError('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
      return;
    }

    if (newPassword !== confirmPassword) {
      showError('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
      return;
    }

    if (newPassword.length < 6) {
      showError('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½');
      return;
    }

    const userId = localStorage.getItem('userId');
    const token = localStorage.getItem('token');
    const savePasswordBtn = document.querySelector('#passwordForm button');
    savePasswordBtn.disabled = true;
    savePasswordBtn.textContent = 'ä¿å­˜ä¸­...';

    try {
      const response = await fetch(`/api/patient/change-password?userId=${userId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
          userId: userId,
          oldPassword: oldPassword,
          newPassword: newPassword
        })
      });

      const data = await response.json();

      if (data.code === 200) {
        showSuccess('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
        document.getElementById('passwordForm').reset();
      } else {
        showError('å¯†ç ä¿®æ”¹å¤±è´¥: ' + data.message);
      }
    } catch (error) {
      console.error('ä¿®æ”¹å¯†ç é”™è¯¯:', error);
      showError('ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    } finally {
      savePasswordBtn.disabled = false;
      savePasswordBtn.textContent = 'ä¿®æ”¹å¯†ç ';
    }
  }

  function showSuccess(message) {
    const successDiv = document.getElementById('successMessage');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    setTimeout(() => {
      successDiv.style.display = 'none';
    }, 3000);
  }

  function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 3000);
  }

  function formatDate(dateString) {
    if (!dateString) return '';
    return dateString.split('T')[0];
  }
</script>
</body>
</html>
